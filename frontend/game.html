<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Details - GameVault</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>ðŸŽ®</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/landing.css">
</head>
<body>
    <nav class="navbar glass">
        <a href="index.html" class="logo">GameVault</a>
        <div class="nav-actions">
            <div id="authLinks">
                <!-- Populated by app.js -->
            </div>
        </div>
    </nav>

    <div style="margin-top: 100px;">
        <div class="container">
            <div id="gameContent" class="details-container">
                <div style="text-align: center;">Loading...</div>
            </div>

            <div style="margin-top: 5rem;">
                <h2 class="section-title">Reviews</h2>
                <div id="reviewsList"></div>
                
                <div id="reviewFormContainer" style="margin-top: 2rem; display: none;">
                    <div class="auth-container" style="margin: 0; max-width: 100%;">
                        <h3 style="margin-bottom: 1rem;">Write a Review</h3>
                        <form id="reviewForm" style="margin-top: 1rem;">
                            <div class="form-group">
                                <label style="margin-bottom: 0.5rem; display: block;">Rating</label>
                                <div class="star-rating" id="starContainer">
                                    <span class="star" data-value="1">â˜…</span>
                                    <span class="star" data-value="2">â˜…</span>
                                    <span class="star" data-value="3">â˜…</span>
                                    <span class="star" data-value="4">â˜…</span>
                                    <span class="star" data-value="5">â˜…</span>
                                </div>
                                <input type="hidden" id="rating" value="" required>
                            </div>
                            <div class="form-group">
                                <label>Comment</label>
                                <input type="text" id="comment" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Review</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('id');

        const loadGame = async () => {
            // ... (keeping loadGame mostly same) ...
            if (!gameId) return;

            const res = await fetch(`${API_URL}/games/${gameId}`);
            const game = await res.json();
            // ... (rest of loadGame rendering) ...
            document.title = `${game.title} - GameVault`;

            document.getElementById('gameContent').innerHTML = `
                <div>
                    <img src="${game.cover_image}" alt="${game.title}" style="width: 100%; border-radius: 20px; border: 1px solid var(--glass-border); box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                </div>
                <div>
                    <h1 style="font-size: 3.5rem; margin-bottom: 1rem; line-height: 1.1;">${game.title}</h1>
                    <div style="margin-bottom: 2rem;">
                        <span class="badge">${game.genre}</span>
                        <span style="color: #aaa; margin-left: 1rem;">Released: ${new Date(game.release_date).toLocaleDateString()}</span>
                    </div>
                    <p style="font-size: 1.1rem; color: #ccc; margin-bottom: 2rem; line-height: 1.6;">${game.description}</p>
                    
                    <div style="margin-bottom: 3rem; display: flex; align-items: center; gap: 1rem;">
                        <span style="color: #fff; font-size: 1rem;">Community Rating:</span>
                        ${getStarDisplayHTML(game.rating || 0, '1.5rem')}
                        <span style="color: #888; font-size: 0.9rem;">(${game.rating || 0}/5)</span>
                    </div>

                    
                    <div style="background: rgba(255,255,255,0.03); padding: 2rem; border-radius: 20px; border: 1px solid var(--glass-border); display: inline-flex; align-items: center; gap: 2rem;">

                        <div>
                            <div style="font-size: 0.9rem; color: #888; margin-bottom: 0.2rem;">Buy now</div>
                            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">$${game.price}</div>
                            <button class="btn btn-primary" style="margin-top: 0.5rem; width: 100%;" onclick="api.addToCart(${game.game_id}, 'buy')">Add to Cart</button>
                        </div>
                        
                        <div style="width: 1px; height: 80px; background: var(--glass-border);"></div>

                        <div>
                            <div style="font-size: 0.9rem; color: #888; margin-bottom: 0.2rem;">Rent</div>
                            <button class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%;" onclick="openRentModal(${game.game_id}, '${game.rental_price}', '${game.title.replace(/'/g, "\\'")}')">Rent Now</button>

                        </div>
                    </div>
                </div>
            `;

            loadReviews();
            if (isAuthenticated()) {
                document.getElementById('reviewFormContainer').style.display = 'block';
            }
        };

        const loadReviews = async () => {
            const res = await fetch(`${API_URL}/reviews/${gameId}`);
            const reviews = await res.json();
            
            const reviewsList = document.getElementById('reviewsList');
            if (reviews.length === 0) {
                reviewsList.innerHTML = '<p style="color: #888;">No reviews yet. Be the first!</p>';
                return;
            }

            reviewsList.innerHTML = reviews.map(r => `
                <div class="review-card">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-weight: bold; color: var(--primary);">${r.username}</span>
                        <span style="color: #888; font-size: 0.9rem;">${new Date(r.review_date).toLocaleDateString()}</span>
                    </div>
                    <div style="color: #ff9800; margin-bottom: 0.5rem;">${'â˜…'.repeat(r.rating)}${'â˜†'.repeat(5-r.rating)}</div>
                    <p style="color: #ddd;">${r.comment}</p>
                </div>
            `).join('');
        };

        document.getElementById('reviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const rating = document.getElementById('rating').value;
            const comment = document.getElementById('comment').value;

            if (!rating) {
                showToast('Please select a star rating!');
                return;
            }

            const user = getUser();

            const res = await fetch(`${API_URL}/reviews`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ userId: user.id, gameId, rating, comment })
            });
            
            if (res.ok) {
                showToast('Review submitted!');
                loadReviews();
                document.getElementById('reviewForm').reset();
                // Reset stars
                document.getElementById('rating').value = '';
                const stars = document.querySelectorAll('.star');
                stars.forEach(s => s.classList.remove('filled'));
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadGame();

            // Star Rating Logic
            const stars = document.querySelectorAll('.star');
            const ratingInput = document.getElementById('rating');
            
            if (stars.length > 0) {
                const updateStars = (val) => {
                    stars.forEach(s => {
                        if (parseInt(s.getAttribute('data-value')) <= val) {
                            s.classList.add('filled');
                        } else {
                            s.classList.remove('filled');
                        }
                    });
                };

                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        const val = parseInt(star.getAttribute('data-value'));
                        ratingInput.value = val;
                        updateStars(val);
                    });
                });

                // Initialize empty
                updateStars(0);
            }
        });
    </script>
</body>
</html>
